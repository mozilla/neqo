name: CI MTU
on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "mtu/**"
      - ".github/workflows/check-mtu.yml"
      - ".github/actions/check-vm/**"
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  generate-bindings:
    name: Generate ${{ matrix.os }} bindings
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-24.04
            header: linux.h
            args: --allowlist-type rtattr|rtmsg|ifinfomsg|nlmsghdr
          - os: macos
            runner: macos-15
            header: bsd.h
            args: --allowlist-type rt_msghdr|rt_metrics|if_data --allowlist-item RTAX_MAX|RTM_GET|RTM_VERSION|RTA_DST|RTA_IFP
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Install bindgen-cli
        run: cargo install bindgen-cli --locked
      - name: Generate bindings
        env:
          OS: ${{ matrix.os }}
          ARGS: ${{ matrix.args }}
          HEADER: ${{ matrix.header }}
        run: |
          # shellcheck disable=SC2086
          bindgen $ARGS --generate-cstr --explicit-padding --with-derive-default "mtu/src/bindings/$HEADER" > "$OS.rs"
      - name: Upload bindings
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: bindings-${{ matrix.os }}
          path: ${{ matrix.os }}.rs

  check-android:
    name: Check Android
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        target: ['x86_64-linux-android', 'i686-linux-android'] # 'aarch64-linux-android' not currently working
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./.github/actions/check-android
        with:
          target: ${{ matrix.target }}
          working-directory: mtu
          github-token: ${{ secrets.GITHUB_TOKEN }}

  check-vm:
    name: Run checks for VM-only platforms
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        os: [ freebsd, openbsd, netbsd, solaris ]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: ./.github/actions/check-vm
        with:
          working-directory: mtu
          platform: ${{ matrix.os }}
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
          generate-bindings: true

  check-bindings:
    name: Check bindings
    needs: [generate-bindings, check-vm]
    if: always() && !cancelled()
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write # to create PRs for binding updates
      contents: write # to push branches for binding updates
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true # zizmor: ignore[artipacked] We need to push branches.

      - name: Download all binding artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: artifacts
          pattern: bindings-*

      - name: Check for binding changes
        id: check
        run: |
          CHANGED=""
          for dir in artifacts/bindings-*; do
            [ -d "$dir" ] || continue
            PLATFORM=$(basename "$dir" | sed 's/bindings-//')
            FILE="$dir/$PLATFORM.rs"
            [ -f "$FILE" ] || continue

            if ! diff -q "mtu/src/bindings/$PLATFORM.rs" "$FILE" > /dev/null 2>&1; then
              echo "Bindings for $PLATFORM differ:"
              diff "mtu/src/bindings/$PLATFORM.rs" "$FILE" || true
              cp "$FILE" "mtu/src/bindings/$PLATFORM.rs"
              CHANGED="$CHANGED $PLATFORM"
            fi
          done

          if [ -z "$CHANGED" ]; then
            echo "No binding changes detected."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "platforms=$CHANGED" >> "$GITHUB_OUTPUT"
          fi

      - name: Create PR for binding updates
        if: steps.check.outputs.changed == 'true' && github.event_name == 'push'
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHA: ${{ github.sha }}
          PLATFORMS: ${{ steps.check.outputs.platforms }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "$TOKEN" | gh auth login --with-token
          SHA_SHORT=$(echo "$SHA" | cut -c1-7)
          BRANCH="chore-update-mtu-bindings-$SHA_SHORT"
          MESSAGE="chore: Update MTU bindings

          Automated update of platform-specific bindings generated by bindgen.

          Updated platforms:$PLATFORMS"
          git checkout -b "$BRANCH"
          git add mtu/src/bindings
          git commit -m "$MESSAGE"
          git push --set-upstream origin "$BRANCH"
          gh pr create --fill-verbose

      - name: Fail if bindings changed on PR
        if: steps.check.outputs.changed == 'true' && github.event_name == 'pull_request'
        run: |
          echo "::error::Generated bindings differ from committed versions. See job output for details."
          exit 1
