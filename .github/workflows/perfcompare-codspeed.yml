name: Performance comparison (CodSpeed)
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  RUSTUP_TOOLCHAIN: stable
  TRANSFER_SIZE: 33554432  # 32 MiB
  # Runner image for build jobs. Keep in sync with runs-on values below.
  # Included in cache keys to auto-invalidate when changed.
  BUILD_RUNNER: ubuntu-22.04-arm
  # Bump this to invalidate all caches for other reasons
  CACHE_VERSION: v6
  # Pinned versions for external implementations
  MSQUIC_VERSION: v2.5.6
  GOOGLE_QUICHE_REF: c52d86fe10442363e4e8c5a66e639187c419d7c0
  CLOUDFLARE_QUICHE_VERSION: 0.24.5
  S2N_QUIC_VERSION: v1.72.0

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

# Build jobs use ARM64 runners because CodSpeed's macro runners are aarch64.
# We use ubuntu-22.04 for glibc compatibility with the CodSpeed runner.
jobs:
  build-neqo:
    name: Build neqo
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: ${{ env.RUSTUP_TOOLCHAIN }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get minimum NSS version
        id: nss-version
        run: echo "minimum=$(cat neqo-crypto/min_version.txt)" >> "$GITHUB_OUTPUT"

      - uses: ./.github/actions/nss
        with:
          minimum-version: ${{ steps.nss-version.outputs.minimum }}

      - name: Build
        run: |
          export RUSTFLAGS="-C force-frame-pointers=yes"
          cargo build --locked --release --features bench --bin neqo-client --bin neqo-server

      - name: Bundle binaries and libraries
        run: |
          mkdir -p dist/neqo/lib
          cp target/release/neqo-client target/release/neqo-server dist/neqo/
          # Copy NSS/NSPR libraries
          cp -L "$NSS_DIR"/../dist/Release/lib/*.so dist/neqo/lib/ 2>/dev/null || true
          cp -L "$NSS_DIR"/../dist/Release/lib/*.so.* dist/neqo/lib/ 2>/dev/null || true
          # Copy test fixture for certificate database
          cp -r test-fixture dist/neqo/

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-neqo
          path: dist/neqo
          retention-days: 1

  build-msquic:
    name: Build msquic
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Restore cached build
        id: cache-restore
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/msquic
          key: ${{ env.CACHE_VERSION }}-msquic-${{ env.MSQUIC_VERSION }}-${{ env.BUILD_RUNNER }}

      - name: Checkout
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: microsoft/msquic
          ref: ${{ env.MSQUIC_VERSION }}
          submodules: recursive
          persist-credentials: false

      - name: Install dependencies
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Build
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p build
          cd build
          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DQUIC_BUILD_TOOLS=1 \
            -DQUIC_BUILD_PERF=1 \
            -DQUIC_BUILD_SHARED=OFF \
            -DCMAKE_EXE_LINKER_FLAGS="-static-libstdc++ -static-libgcc" \
            ..
          cmake --build .

      - name: Bundle binaries
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p dist/msquic
          cp build/bin/Release/quicinterop build/bin/Release/quicinteropserver dist/msquic/

      - name: Save cache
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/msquic
          key: ${{ env.CACHE_VERSION }}-msquic-${{ env.MSQUIC_VERSION }}-${{ env.BUILD_RUNNER }}

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-msquic
          path: dist/msquic
          retention-days: 1

  build-google:
    name: Build google/quiche
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Install bazelisk
        id: bazel-version
        env:
          ARCH: ${{ runner.arch == 'ARM64' && 'arm64' || 'amd64' }}
        run: |
          sudo curl -fsSL -o /usr/local/bin/bazel "https://github.com/bazelbuild/bazelisk/releases/download/v1.25.0/bazelisk-linux-$ARCH"
          sudo chmod +x /usr/local/bin/bazel
          echo "version=$(bazel --version | head -1)" >> "$GITHUB_OUTPUT"

      - name: Restore cached build
        id: cache-restore
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/google-quiche
          key: ${{ env.CACHE_VERSION }}-google-quiche-${{ env.GOOGLE_QUICHE_REF }}-${{ env.BUILD_RUNNER }}-${{ steps.bazel-version.outputs.version }}

      - name: Checkout
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: google/quiche
          ref: ${{ env.GOOGLE_QUICHE_REF }}
          submodules: recursive
          persist-credentials: false

      # TODO: Remove this step when we move to ubuntu-24.04 or newer.
      - name: Use GCC 13
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

      - name: Build
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          bazel build -c opt \
            --action_env=CC=gcc-13 \
            --action_env=CXX=g++-13 \
            --linkopt=-l:libstdc++.a \
            --linkopt=-l:libgcc.a \
            --linkopt=-lpthread \
            --linkopt=-lm \
            quiche:quic_server quiche:quic_client
          bazel shutdown

      - name: Bundle binaries
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p dist/google-quiche
          cp bazel-bin/quiche/quic_server bazel-bin/quiche/quic_client dist/google-quiche/

      - name: Save cache
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/google-quiche
          key: ${{ env.CACHE_VERSION }}-google-quiche-${{ env.GOOGLE_QUICHE_REF }}-${{ env.BUILD_RUNNER }}-${{ steps.bazel-version.outputs.version }}

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-google
          path: dist/google-quiche
          retention-days: 1

  build-quiche:
    name: Build cloudflare/quiche
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Get Rust version
        id: rust-version
        env:
          TOOLCHAIN: ${{ env.RUSTUP_TOOLCHAIN }}
        run: |
          rustup update "$TOOLCHAIN" 2>&1 | head -1
          echo "hash=$(rustc +"$TOOLCHAIN" --version | sha256sum | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Restore cached build
        id: cache-restore
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/quiche
          key: ${{ env.CACHE_VERSION }}-cloudflare-quiche-${{ env.CLOUDFLARE_QUICHE_VERSION }}-${{ env.BUILD_RUNNER }}-rust-${{ steps.rust-version.outputs.hash }}

      - name: Checkout
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: cloudflare/quiche
          ref: ${{ env.CLOUDFLARE_QUICHE_VERSION }}
          submodules: recursive
          persist-credentials: false

      - name: Build
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          export RUSTFLAGS="-C force-frame-pointers=yes"
          cargo build --release --bin quiche-client --bin quiche-server

      - name: Bundle binaries
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p dist/quiche
          cp target/release/quiche-client target/release/quiche-server dist/quiche/

      - name: Save cache
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/quiche
          key: ${{ env.CACHE_VERSION }}-cloudflare-quiche-${{ env.CLOUDFLARE_QUICHE_VERSION }}-${{ env.BUILD_RUNNER }}-rust-${{ steps.rust-version.outputs.hash }}

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-quiche
          path: dist/quiche
          retention-days: 1

  build-s2n:
    name: Build s2n-quic
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Get Rust version
        id: rust-version
        env:
          TOOLCHAIN: ${{ env.RUSTUP_TOOLCHAIN }}
        run: |
          rustup update "$TOOLCHAIN" 2>&1 | head -1
          echo "hash=$(rustc +"$TOOLCHAIN" --version | sha256sum | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Restore cached build
        id: cache-restore
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/s2n-quic
          key: ${{ env.CACHE_VERSION }}-s2n-quic-${{ env.S2N_QUIC_VERSION }}-${{ env.BUILD_RUNNER }}-rust-${{ steps.rust-version.outputs.hash }}

      - name: Checkout
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: aws/s2n-quic
          ref: ${{ env.S2N_QUIC_VERSION }}
          submodules: recursive
          persist-credentials: false

      - name: Build
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          export RUSTFLAGS="-C force-frame-pointers=yes"
          cargo build --release --bin s2n-quic-qns

      - name: Bundle binaries
        if: steps.cache-restore.outputs.cache-hit != 'true'
        run: |
          mkdir -p dist/s2n-quic
          cp target/release/s2n-quic-qns dist/s2n-quic/

      - name: Save cache
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: dist/s2n-quic
          key: ${{ env.CACHE_VERSION }}-s2n-quic-${{ env.S2N_QUIC_VERSION }}-${{ env.BUILD_RUNNER }}-rust-${{ steps.rust-version.outputs.hash }}

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-s2n
          path: dist/s2n-quic
          retention-days: 1

  benchmark:
    name: ${{ matrix.client }}-${{ matrix.server }}${{ matrix.cubic && '-cubic' || '' }}${{ matrix.pacing && '' || '-nopacing' }}
    needs: [build-neqo, build-msquic, build-google, build-quiche, build-s2n]
    runs-on: # zizmor: ignore[self-hosted-runner]
      group: codspeed
      labels: codspeed-macro
    strategy:
      fail-fast: false
      matrix:
        include:
          - {client: neqo,   server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: neqo,   cubic: true,  pacing: false}
          - {client: neqo,   server: neqo,   cubic: false, pacing: true}
          - {client: neqo,   server: neqo,   cubic: false, pacing: false}
          - {client: neqo,   server: msquic, cubic: true,  pacing: true}
          - {client: msquic, server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: google, cubic: true,  pacing: true}
          - {client: google, server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: quiche, cubic: true,  pacing: true}
          - {client: quiche, server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: s2n,    cubic: true,  pacing: true}
          - {client: s2n,    server: neqo,   cubic: true,  pacing: true}
    env:
      HOST: 127.0.0.1
      PORT: 4433

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-neqo
          path: build-neqo
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        if: matrix.client != 'neqo' || matrix.server != 'neqo'
        with:
          name: build-${{ matrix.client != 'neqo' && matrix.client || matrix.server }}
          path: build-${{ matrix.client != 'neqo' && matrix.client || matrix.server }}

      - run: chmod +x build-*/*

      - name: Setup test environment
        run: |
          sudo ip link set dev lo mtu 1500
          mkdir -p testdata
          openssl req -nodes -new -x509 -keyout testdata/key -out testdata/cert -subj "/CN=localhost"
          truncate -s "$TRANSFER_SIZE" "testdata/$TRANSFER_SIZE"

      - name: Set environment
        run: |
          {
            echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/build-neqo/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$GITHUB_WORKSPACE/build-neqo/test-fixture/db"
          } >> "$GITHUB_ENV"

      - name: Generate commands
        env:
          CLIENT: ${{ matrix.client }}
          SERVER: ${{ matrix.server }}
          CUBIC: ${{ matrix.cubic }}
          PACING: ${{ matrix.pacing }}
        run: |
          NAME="$CLIENT-$SERVER"
          CC=$([[ "$CUBIC" == "true" ]] && echo "cubic" || echo "newreno")
          NEQO_ARGS="--cc $CC -Q 1"
          if [[ "$PACING" != "true" ]]; then
            NEQO_ARGS="$NEQO_ARGS --no-pacing"
          fi
          # Add interop flag when communicating with s2n or msquic
          INTEROP=""
          if [[ "$CLIENT" == "s2n" || "$SERVER" == "s2n" || "$CLIENT" == "msquic" || "$SERVER" == "msquic" ]]; then
            INTEROP="-a hq-interop"
          fi
          # Add cc/pacing to name for neqo-neqo benchmarks
          if [[ "$CLIENT" == "neqo" && "$SERVER" == "neqo" ]]; then
            NAME="$NAME-$CC"
            [[ "$PACING" != "true" ]] && NAME="$NAME-nopacing"
          fi

          # Use full paths since CodSpeed doesn't inherit GITHUB_PATH
          NEQO="$GITHUB_WORKSPACE/build-neqo"
          MSQUIC="$GITHUB_WORKSPACE/build-msquic"
          GOOGLE="$GITHUB_WORKSPACE/build-google"
          QUICHE="$GITHUB_WORKSPACE/build-quiche"
          S2N="$GITHUB_WORKSPACE/build-s2n"
          TESTDATA="$GITHUB_WORKSPACE/testdata"

          case "$SERVER" in
            neqo)   SERVER_CMD="$NEQO/neqo-server $NEQO_ARGS $INTEROP $HOST:$PORT" ;;
            msquic) SERVER_CMD="$MSQUIC/quicinteropserver -root:$TESTDATA -listen:$HOST -port:$PORT -file:$TESTDATA/cert -key:$TESTDATA/key -noexit" ;;
            google) SERVER_CMD="$GOOGLE/quic_server --generate_dynamic_responses --port $PORT --certificate_file $TESTDATA/cert --key_file $TESTDATA/key" ;;
            quiche) SERVER_CMD="$QUICHE/quiche-server --root $TESTDATA --listen $HOST:$PORT --cert $TESTDATA/cert --key $TESTDATA/key" ;;
            s2n)    SERVER_CMD="$S2N/s2n-quic-qns interop server --www-dir $TESTDATA --certificate $TESTDATA/cert --private-key $TESTDATA/key --ip $HOST --port $PORT" ;;
          esac

          case "$CLIENT" in
            neqo)   CLIENT_CMD="$NEQO/neqo-client $NEQO_ARGS $INTEROP --output-dir . https://$HOST:$PORT/$TRANSFER_SIZE" ;;
            msquic) CLIENT_CMD="$MSQUIC/quicinterop -test:D -custom:$HOST -port:$PORT -urls:https://$HOST:$PORT/$TRANSFER_SIZE" ;;
            google) CLIENT_CMD="bash -c \"$GOOGLE/quic_client --disable_certificate_verification https://$HOST:$PORT/$TRANSFER_SIZE > $TRANSFER_SIZE\"" ;;
            quiche) CLIENT_CMD="$QUICHE/quiche-client --no-verify --dump-responses . https://$HOST:$PORT/$TRANSFER_SIZE" ;;
            s2n)    CLIENT_CMD="$S2N/s2n-quic-qns interop client --tls rustls --disable-cert-verification --download-dir . --local-ip $HOST https://$HOST:$PORT/$TRANSFER_SIZE" ;;
          esac

          {
            echo "BENCH_NAME=$NAME"
            echo "SERVER_CMD=$SERVER_CMD"
            echo "CLIENT_CMD=$CLIENT_CMD"
          } >> "$GITHUB_ENV"

      - name: Start server
        run: |
          # shellcheck disable=SC2086
          $SERVER_CMD &
          echo "SERVER_PID=$!" >> "$GITHUB_ENV"
          sleep 1

      - name: Create benchmark config
        run: |
          {
            echo "benchmarks:"
            echo "  - name: \"$BENCH_NAME\""
            echo "    exec: $CLIENT_CMD"
            echo "    options:"
            echo "      min-rounds: 500"
          } > codspeed.yml

      # TODO: Pin to release version once CodSpeed releases config file support
      - name: Run benchmark
        uses: CodSpeedHQ/action@main # zizmor: ignore[unpinned-uses]
        with:
          mode: walltime
          working-directory: /tmp
          token: ${{ secrets.CODSPEED_TOKEN }}

      - name: Verify transfer
        working-directory: /tmp
        run: |
          SIZE=$(stat -c%s "$TRANSFER_SIZE" 2>/dev/null || stat -f%z "$TRANSFER_SIZE")
          if [[ "$SIZE" -lt "$TRANSFER_SIZE" ]]; then
            echo "Transfer failed: expected $TRANSFER_SIZE bytes, got $SIZE"
            exit 1
          fi

      - name: Stop server
        if: always()
        run: kill "$SERVER_PID" 2>/dev/null || true
