name: CodSpeed
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTUP_TOOLCHAIN: stable
  # Performance comparison settings
  TRANSFER_SIZE: 33554432  # 32 MiB

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  bench-matrix:
    name: Determine bench matrix
    runs-on: ubuntu-24.04
    outputs:
      benches: ${{ steps.matrix.outputs.benches }}
      walltime-benches: ${{ steps.matrix.outputs.walltime-benches }}
      has-walltime: ${{ steps.matrix.outputs.has-walltime }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - id: matrix
        uses: ./.github/actions/bench-matrix

  # Build neqo for walltime benchmarks and perfcompare on ARM64.
  # CodSpeed's macro runners are aarch64, so we build on ARM for compatibility.
  # Using ubuntu-22.04 for glibc compatibility with CodSpeed runners.
  build-neqo:
    name: Build neqo
    runs-on: ubuntu-22.04-arm
    needs: bench-matrix
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          tools: cargo-codspeed
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./.github/actions/nss

      - name: Build neqo binaries
        run: |
          export RUSTFLAGS="-C force-frame-pointers=yes"
          cargo build --locked --profile bench --features bench --bin neqo-client --bin neqo-server

      - name: Build walltime benchmarks
        if: needs.bench-matrix.outputs.has-walltime == 'true'
        env:
          WALLTIME_BENCHES: ${{ needs.bench-matrix.outputs.walltime-benches }}
        run: |
          echo "$WALLTIME_BENCHES" | jq -r '.[] | "\(.crate) \(.bench)"' | while read -r crate bench; do
            echo "::group::Building $crate::$bench"
            cargo codspeed build --package "$crate" --locked --features bench --bench "$bench" --measurement-mode walltime
            echo "::endgroup::"
          done

      - name: Bundle artifacts
        run: |
          mkdir -p dist/lib
          # Neqo binaries
          cp target/release/neqo-client target/release/neqo-server dist/
          # Codspeed benchmarks
          cp -r target/codspeed dist/
          # Test fixture for certificate database
          cp -r test-fixture dist/
          # NSS/NSPR libraries
          if [ -d "$NSS_DIR/../dist/Release/lib" ]; then
            cp -L "$NSS_DIR"/../dist/Release/lib/*.so dist/lib/ 2>/dev/null || true
            cp -L "$NSS_DIR"/../dist/Release/lib/*.so.* dist/lib/ 2>/dev/null || true
          else
            for lib in nss3 nssutil3 smime3 ssl3 nspr4 plc4 plds4; do
              cp -L /usr/lib/*/lib${lib}.so* dist/lib/ 2>/dev/null || true
            done
          fi

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-neqo
          path: dist
          retention-days: 1

  build-msquic:
    name: Build msquic
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: msquic
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-msquic

  build-google:
    name: Build google/quiche
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: google
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-google

  build-quiche:
    name: Build cloudflare/quiche
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: quiche
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-quiche

  build-s2n:
    name: Build s2n-quic
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          sparse-checkout: .github/actions
          persist-credentials: false

      - uses: ./.github/actions/quic-build
        with:
          impl: s2n
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact-name: build-s2n

  benchmarks:
    name: Run ${{ matrix.bench.bench }} (${{ matrix.bench.mode }})
    runs-on: ${{ matrix.bench.runner }}
    needs: bench-matrix
    if: ${{ needs.bench-matrix.outputs.benches != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        bench: ${{ fromJson(needs.bench-matrix.outputs.benches) }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          tools: cargo-codspeed
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: ./.github/actions/nss

      - name: Build bench
        env:
          BENCH: ${{ matrix.bench.bench }}
          CRATE: ${{ matrix.bench.crate }}
          MODE: ${{ matrix.bench.mode }}
        run: cargo codspeed build --package "$CRATE" --locked --features bench --bench "$BENCH" --measurement-mode "$MODE"

      - name: Run bench & upload results
        uses: CodSpeedHQ/action@0700edb451d0e9f2426f99bd6977027e550fb2a6 # v4.7.0
        with:
          mode: ${{ matrix.bench.mode }}
          run: cargo codspeed run
          token: ${{ secrets.CODSPEED_TOKEN }}

  benchmarks-walltime:
    name: Run ${{ matrix.bench.bench }} (walltime)
    runs-on: # zizmor: ignore[self-hosted-runner]
      group: codspeed
      labels: codspeed-macro
    needs: [bench-matrix, build-neqo]
    if: ${{ needs.bench-matrix.outputs.has-walltime == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        bench: ${{ fromJson(needs.bench-matrix.outputs.walltime-benches) }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          tools: cargo-codspeed
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-neqo
          path: dist

      - name: Set up build artifacts
        run: |
          mkdir -p target
          mv dist/codspeed target/
          find target/codspeed -type f -exec chmod +x {} +
          {
            echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/dist/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$GITHUB_WORKSPACE/dist/test-fixture/db"
          } >> "$GITHUB_ENV"

      # Disable turboboost, hyperthreading and use performance governor.
      - name: Prepare machine
        run: |
          echo "::group::CPU Information"
          echo "=== /proc/cpuinfo ==="
          cat /proc/cpuinfo || echo "::error::Failed to read /proc/cpuinfo"
          echo "=== CPU topology ==="
          lscpu || echo "::error::lscpu not available"
          echo "=== Online CPUs ==="
          cat /sys/devices/system/cpu/online || echo "::error::Failed to read online CPUs"
          echo "=== CPU max frequencies (to identify big/little cores) ==="
          for f in /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq; do
            if [ -f "$f" ]; then
              cpu=$(echo "$f" | grep -o 'cpu[0-9]*')
              freq=$(cat "$f")
              echo "$cpu: $freq kHz"
            fi
          done
          echo "::endgroup::"

          echo "::group::Applying CPU tuning"
          # Set CPU governor to performance for all CPUs
          for gov in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
            if [ -f "$gov" ]; then
              if ! echo performance | sudo tee "$gov" > /dev/null 2>&1; then
                echo "::error::Failed to set performance governor for $gov"
              fi
            fi
          done
          # Disable SMT/hyperthreading if available
          if [ -f /sys/devices/system/cpu/smt/control ]; then
            if ! echo off | sudo tee /sys/devices/system/cpu/smt/control > /dev/null 2>&1; then
              echo "::error::Failed to disable SMT"
            fi
          fi
          # Disable boost via per-policy boost control
          for boost in /sys/devices/system/cpu/cpufreq/policy*/boost; do
            if [ -f "$boost" ]; then
              if ! echo 0 | sudo tee "$boost" > /dev/null 2>&1; then
                echo "::error::Failed to disable boost for $boost"
              fi
            fi
          done
          echo "::endgroup::"

      - name: Run bench & upload results
        uses: CodSpeedHQ/action@0700edb451d0e9f2426f99bd6977027e550fb2a6 # v4.7.0
        with:
          mode: walltime
          run: cargo codspeed run --package ${{ matrix.bench.crate }} --bench ${{ matrix.bench.bench }}
          token: ${{ secrets.CODSPEED_TOKEN }}

  perfcompare:
    name: ${{ matrix.client }}-${{ matrix.server }}${{ matrix.cubic && '-cubic' || '' }}${{ matrix.pacing == false && '-nopacing' || '' }}
    needs: [build-neqo, build-msquic, build-google, build-quiche, build-s2n]
    runs-on: # zizmor: ignore[self-hosted-runner]
      group: codspeed
      labels: codspeed-macro
    strategy:
      fail-fast: false
      matrix:
        include:
          # neqo vs neqo: all cc/pacing combinations
          - {client: neqo,   server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: neqo,   cubic: true,  pacing: false}
          - {client: neqo,   server: neqo,   cubic: false, pacing: true}
          - {client: neqo,   server: neqo,   cubic: false, pacing: false}
          # Same-implementation baselines (cubic/pacing not applicable)
          - {client: msquic, server: msquic}
          - {client: google, server: google}
          - {client: quiche, server: quiche}
          - {client: s2n,    server: s2n}
          # neqo vs others
          - {client: neqo,   server: msquic, cubic: true,  pacing: true}
          - {client: msquic, server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: google, cubic: true,  pacing: true}
          - {client: google, server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: quiche, cubic: true,  pacing: true}
          - {client: quiche, server: neqo,   cubic: true,  pacing: true}
          - {client: neqo,   server: s2n,    cubic: true,  pacing: true}
          - {client: s2n,    server: neqo,   cubic: true,  pacing: true}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: ./.github/actions/rust
        with:
          version: stable
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        if: matrix.client == 'neqo' || matrix.server == 'neqo'
        with:
          name: build-neqo
          path: build-neqo
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        if: matrix.client != 'neqo'
        with:
          name: build-${{ matrix.client }}
          path: build-${{ matrix.client }}
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        if: matrix.server != 'neqo' && matrix.server != matrix.client
        with:
          name: build-${{ matrix.server }}
          path: build-${{ matrix.server }}

      - run: chmod +x build-*/*

      - name: Setup test environment
        uses: ./.github/actions/testdata-setup
        with:
          sizes: ${{ env.TRANSFER_SIZE }}
          mtu: '1500'

      - name: Set environment
        run: |
          {
            echo "LD_LIBRARY_PATH=$GITHUB_WORKSPACE/build-neqo/lib:$LD_LIBRARY_PATH"
            echo "NSS_DB_PATH=$GITHUB_WORKSPACE/build-neqo/test-fixture/db"
          } >> "$GITHUB_ENV"

      # Disable turboboost, hyperthreading and use performance governor.
      # Also determine suitable physical cores for pinning client and server.
      - name: Prepare machine
        run: |
          echo "::group::CPU Information"
          echo "=== /proc/cpuinfo ==="
          cat /proc/cpuinfo || echo "::error::Failed to read /proc/cpuinfo"
          echo "=== CPU topology ==="
          lscpu || echo "::error::lscpu not available"
          echo "=== Online CPUs ==="
          cat /sys/devices/system/cpu/online || echo "::error::Failed to read online CPUs"
          echo "=== CPU max frequencies (to identify big/little cores) ==="
          for f in /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq; do
            if [ -f "$f" ]; then
              cpu=$(echo "$f" | grep -o 'cpu[0-9]*')
              freq=$(cat "$f")
              echo "$cpu: $freq kHz"
            fi
          done
          echo "::endgroup::"

          echo "::group::Applying CPU tuning"
          # Set CPU governor to performance for all CPUs
          for gov in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
            if [ -f "$gov" ]; then
              if ! echo performance | sudo tee "$gov" > /dev/null 2>&1; then
                echo "::error::Failed to set performance governor for $gov"
              fi
            fi
          done
          # Disable SMT/hyperthreading if available
          if [ -f /sys/devices/system/cpu/smt/control ]; then
            if ! echo off | sudo tee /sys/devices/system/cpu/smt/control > /dev/null 2>&1; then
              echo "::error::Failed to disable SMT"
            fi
          fi
          # Disable boost via per-policy boost control
          for boost in /sys/devices/system/cpu/cpufreq/policy*/boost; do
            if [ -f "$boost" ]; then
              if ! echo 0 | sudo tee "$boost" > /dev/null 2>&1; then
                echo "::error::Failed to disable boost for $boost"
              fi
            fi
          done
          echo "::endgroup::"

          echo "::group::Selecting CPUs for pinning"
          # Find physical cores by looking at core_id. Cores with the same core_id are SMT siblings.
          # We want two different physical cores for server and client.
          declare -A core_to_cpu
          for cpu_path in /sys/devices/system/cpu/cpu[0-9]*; do
            cpu=$(basename "$cpu_path")
            cpu_num=${cpu#cpu}
            core_id_file="$cpu_path/topology/core_id"
            if [ -f "$core_id_file" ]; then
              core_id=$(cat "$core_id_file")
              # Only keep the first CPU for each physical core
              if [ -z "${core_to_cpu[$core_id]}" ]; then
                core_to_cpu[$core_id]=$cpu_num
              fi
            fi
          done
          # Get list of unique physical cores
          mapfile -t physical_cpus < <(printf '%s\n' "${core_to_cpu[@]}")
          echo "Physical core CPU mapping: ${core_to_cpu[*]}"
          echo "Available physical cores (first CPU of each): ${physical_cpus[*]}"

          # Select two different physical cores, preferring higher-numbered ones
          # (to avoid interference with system processes typically on CPU 0)
          mapfile -t sorted < <(printf '%s\n' "${physical_cpus[@]}" | sort -rn)
          if [ ${#sorted[@]} -ge 2 ]; then
            SERVER_CPU=${sorted[0]}
            CLIENT_CPU=${sorted[1]}
          elif [ ${#sorted[@]} -eq 1 ]; then
            SERVER_CPU=${sorted[0]}
            CLIENT_CPU=${sorted[0]}
            echo "::warning::Only one physical core available, server and client will share CPU $SERVER_CPU"
          else
            SERVER_CPU=0
            CLIENT_CPU=1
            echo "::warning::Could not determine physical cores, using CPUs 0 and 1"
          fi
          echo "Selected SERVER_CPU=$SERVER_CPU, CLIENT_CPU=$CLIENT_CPU"
          {
            echo "SERVER_CPU=$SERVER_CPU"
            echo "CLIENT_CPU=$CLIENT_CPU"
          } >> "$GITHUB_ENV"
          echo "::endgroup::"

      - name: Generate commands
        id: commands
        uses: ./.github/actions/perfcompare-commands
        with:
          client: ${{ matrix.client }}
          server: ${{ matrix.server }}
          size: ${{ env.TRANSFER_SIZE }}
          cubic: ${{ matrix.cubic }}
          pacing: ${{ matrix.pacing }}
          neqo-path: ${{ github.workspace }}/build-neqo
          msquic-path: ${{ github.workspace }}/build-msquic
          google-path: ${{ github.workspace }}/build-google
          quiche-path: ${{ github.workspace }}/build-quiche
          s2n-path: ${{ github.workspace }}/build-s2n
          testdata-path: ${{ github.workspace }}/testdata

      - name: Set command environment
        env:
          BENCH_NAME: ${{ steps.commands.outputs.bench-name }}
          SERVER_CMD: ${{ steps.commands.outputs.server-cmd }}
          CLIENT_CMD: ${{ steps.commands.outputs.client-cmd }}
        run: |
          {
            echo "BENCH_NAME=$BENCH_NAME"
            echo "SERVER_CMD=$SERVER_CMD"
            echo "CLIENT_CMD=$CLIENT_CMD"
          } >> "$GITHUB_ENV"

      - name: Start server
        run: |
          # shellcheck disable=SC2086
          taskset -c "$SERVER_CPU" $SERVER_CMD &
          echo "SERVER_PID=$!" >> "$GITHUB_ENV"
          sleep 1

      - name: Create benchmark config
        run: |
          {
            echo "benchmarks:"
            echo "  - name: \"$BENCH_NAME\""
            echo "    exec: taskset -c $CLIENT_CPU $CLIENT_CMD"
            echo "    options:"
            echo "      min-rounds: 500"
          } > codspeed.yml

      # TODO: Pin to release version once CodSpeed releases config file support
      - name: Run benchmark
        uses: CodSpeedHQ/action@main # zizmor: ignore[unpinned-uses]
        with:
          mode: walltime
          working-directory: /tmp
          token: ${{ secrets.CODSPEED_TOKEN }}

      - name: Verify transfer
        working-directory: /tmp
        run: |
          SIZE=$(stat -c%s "$TRANSFER_SIZE" 2>/dev/null || stat -f%z "$TRANSFER_SIZE")
          if [[ "$SIZE" -lt "$TRANSFER_SIZE" ]]; then
            echo "Transfer failed: expected $TRANSFER_SIZE bytes, got $SIZE"
            exit 1
          fi

      - name: Stop server
        if: always()
        run: kill "$SERVER_PID" 2>/dev/null || true

