name: Install Rust
description: Install Rust and sccache

inputs:
  version:
    description: 'Rust toolchain version to install'
    required: true
    default: 'stable'
  components:
    description: 'Rust components to install'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ inputs.version }}
        components: ${{ inputs.components }}

    - name: Install cargo-binstall (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: Set-ExecutionPolicy Unrestricted -Scope Process; iex (iwr "https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.ps1").Content

    - name: Install cargo-binstall (Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash

    - name: Install Rust tools
      shell: bash
      run: cargo +${{ inputs.version }} binstall --no-confirm cargo-llvm-cov cargo-nextest flamegraph cargo-hack

    - name: Use Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        cache-all-crates: "true"
        cache-directories: "${{ github.workspace }}/dist"
